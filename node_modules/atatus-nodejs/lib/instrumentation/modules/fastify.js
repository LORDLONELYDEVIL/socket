'use strict'

// Instrumentation of fastify.
// https://www.fastify.io/docs/latest/LTS/

const semver = require('semver')

module.exports = function (fastify, agent, { version, enabled }) {
  if (!enabled) return fastify

  agent.setFramework({ name: 'Fastify', version, overwrite: false })

  agent.logger.debug('wrapping fastify build function')

  if (semver.gte(version, '4.0.0')) {
    wrappedBuild4Plus.default = wrappedBuild4Plus
    wrappedBuild4Plus.fastify = wrappedBuild4Plus
    return wrappedBuild4Plus
  }

  if (semver.gte(version, '3.0.0') && semver.lt(version, '4.0.0')) {
    wrappedBuild3Plus.default = wrappedBuild3Plus
    wrappedBuild3Plus.fastify = wrappedBuild3Plus
    return wrappedBuild3Plus
  }

  if (semver.gte(version, '2.0.0-rc')) return wrappedBuild2Plus

  return wrappedBuildPre2

  function wrappedBuild4Plus () {
    const _fastify = fastify.apply(null, arguments)

    agent.logger.debug('adding onRequest hook to fastify')
    _fastify.addHook('onRequest', (req, reply, next) => {
      const routeOptions = req.routeOptions || {}
      const config = routeOptions.config || {}
      const method = routeOptions.method || req.raw.method // Fallback for fastify >4
      const url = routeOptions.url || config.url // Fallback for fastify >4
      const name = method + ' ' + url
      agent.logger.debug('fastify: routeOptions - ', routeOptions)
      agent.logger.debug('fastify: routeOptions.config - ', routeOptions.config)
      agent._instrumentation.setDefaultTransactionName(name)
      next()
    })

    // Save the parsed req body to be picked up by getContextFromRequest().
    _fastify.addHook('preHandler', (req, reply, next) => {
      req.raw.body = req.body
      next()
    })

    agent.logger.debug('adding onError hook to fastify')
    _fastify.addHook('onError', (req, reply, err, next) => {
      agent.captureError(err, { request: req.raw })
      next()
    })

    return _fastify
  }

  function wrappedBuild3Plus () {
    const _fastify = fastify.apply(null, arguments)

    agent.logger.debug('adding onRequest hook to fastify')
    _fastify.addHook('onRequest', (req, reply, next) => {
      const method = req.routerMethod || req.raw.method // Fallback for fastify >3 <3.3.0
      const url = req.routerPath || reply.context.config.url // Fallback for fastify >3 <3.3.0
      const name = method + ' ' + url
      agent.logger.debug('fastify: req.routerPath - ', req.routerPath)
      agent.logger.debug('fastify: reply.context.config - ', reply.context.config)
      agent._instrumentation.setDefaultTransactionName(name)
      next()
    })

    // Save the parsed req body to be picked up by getContextFromRequest().
    _fastify.addHook('preHandler', (req, reply, next) => {
      req.raw.body = req.body
      next()
    })

    agent.logger.debug('adding onError hook to fastify')
    _fastify.addHook('onError', (req, reply, err, next) => {
      agent.captureError(err, { request: req.raw })
      next()
    })

    return _fastify
  }

  function wrappedBuild2Plus () {
    const _fastify = fastify.apply(null, arguments)

    agent.logger.debug('adding onRequest hook to fastify')
    _fastify.addHook('onRequest', (req, reply, next) => {
      const context = reply.context
      const name = req.raw.method + ' ' + context.config.url
      agent.logger.debug('fastify2: req.routerPath - ', req.routerPath)
      agent.logger.debug('fastify2: context.config - ', context.config)
      agent._instrumentation.setDefaultTransactionName(name)
      next()
    })

    // Save the parsed req body to be picked up by getContextFromRequest().
    _fastify.addHook('preHandler', (req, reply, next) => {
      req.raw.body = req.body
      next()
    })

    agent.logger.debug('adding onError hook to fastify')
    _fastify.addHook('onError', (req, reply, err, next) => {
      agent.captureError(err, { request: req.raw })
      next()
    })

    return _fastify
  }

  function wrappedBuildPre2 () {
    const _fastify = fastify.apply(null, arguments)

    agent.logger.debug('adding onRequest hook to fastify')
    _fastify.addHook('onRequest', (req, reply, next) => {
      const context = reply._context
      const name = req.method + ' ' + context.config.url
      agent.logger.debug('fastify1: req.routerPath - ', req.routerPath)
      agent.logger.debug('fastify1: context.config - ', context.config)
      agent._instrumentation.setDefaultTransactionName(name)
      next()
    })

    agent.logger.warn('Atatus agent cannot automatically capture errors on this version of Fastify. Upgrade to version 2.0.0 or later.')

    return _fastify
  }
}
